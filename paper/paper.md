---
title: 'PsiRESP: calculating RESP charges with Psi4'
tags:
  - Python
  - molecular dynamics
  - atomic partial charges
  - force fields
  - resp
authors:
  - name: Lily Wang
    orcid: 0000-0002-6095-6704
    affiliation: 1
  - name: Megan L. O'Mara^[corresponding author]
    orcid: 0000-0002-8764-1585
    affiliation: 1
affiliations:
 - name: Research School of Chemistry, College of Science, Australian National University, Canberra, ACT, 2601, Australia
   index: 1
date: 16 December 2021
bibliography: paper.bib
---

# Background

Molecular dynamics (MD) simulations have become a fundamental tool in biomedical and materials research. The accuracy of a MD simulation depends on its ability to model the physics of the chosen system, a capacity that arises from the parameters used to model bonded and non-bonded interactions between atoms (also known as a “force field”). Non-bonded interactions comprise Lennard-Jones and electrostatic interactions. Electrostatic interactions between non-bonded atoms are typically modelled as pairwise interactions between atomic partial charges. 

A number of methods have been developed to generate molecular partial charges, and results vary widely between each method. Approaches based on quantum mechanics calculations typically follow one of three strategies: wavefunction population analysis (e.g. Mulliken charges [@mulliken1955], Löwdin charges [@lowdin1950]); partitioning the distribution of electron density (e.g. Hirshfield charges [@hirshfeld1977]); or reproducing the electrostatic potential (ESP) outside the molecular surface. The major classical biomolecular force fields generally obtain charges using the last strategy.

## ESP

The electrostatic potential $V$ is the potential generated by the nuclei and electrons in a molecule. At any point in space $r$, it is:
$$V(\vec{r}) = \sum_{n=1}^{nuclei} \frac{Z_n}{|\vec{r} - \vec{R}_n|} - \int \frac{\rho(\vec{r’})}{|\vec{r} - \vec{r’}|} d\vec{r}$$

The “ESP” method published by Singh and Kollman in 1984 [@singh1984] evaluates the electrostatic potential on a grid of points around the molecule. This approach is still used by the Automated Topology Builder [@malde2011] to derive charges for GROMOS. However, it is difficult to distinguish the contribution of buried atoms within the molecule to the electrostatic potential at the surface.  As a result, the charges assigned to the buried atoms can vary substantially with minor changes in geometry. 

## RESP

The restrained electrostatic potential (RESP) [@bayly1993; @cornell1993; @cieplak1995] approach introduces a hyperbolic restraint towards 0, penalizing charges with high magnitudes. This is intended to reduce overfitting and hence the variation between charges, resulting in charges that are more easily transferable between molecules and less conformationally dependent. The function follows the form:

$$\chi_{penalty} = a\sum_{n=1}^{nuclei} ((q_{n}^{2} + b^2)^{1/2} – b)$$

$a$ defines the asymptotic limits of the penalty, while $b$ controls its width, or its degree of curvature at the minimum. $b$ is typically set to 0.1 e. In a two-stage fit, $a$ is usually tightened (increased) in the second stage. The standard values are 0.0005 au for the first stage, and 0.001 for the second stage. Hydrogens are often excluded in the hyperbolic penalty. Two-stage RESP is the typical charge model employed by the AMBER and GLYCAM force fields. 

## RESP2

The HF/6-31G* level of theory commonly used for RESP charge derivation overestimates the gas-phase polarity of molecules [@carlson1993]. The recently published RESP2 [@schauperl2020] addresses this issue by using a higher level of QM theory, as well as combining charges fitted to both gas- and aqueous-phase data. While optimising charge parameters alone without modifying Lennard-Jones parameters may not increase the accuracy of simulations [@mobley2007], both parameters can be co-optimised for greater accuracy. 

## Existing tools

Several tools already exist for fitting ESP-based charges. The canonical program is `resp` [@bayly1993],written in FORTRAN and distributed by the AmberTools package [@case]. However, using this with multiple molecules is a tedious and manual process. As the charge distribution of a molecule is highly dependent on its conformation, it is often necessary to examine multiple conformers and orientations of a molecule to obtain a general charge distribution that can be used to derive atomic partial charges [@reynolds1992]. In order to use the `resp` program, different conformers and orientations must be manually generated, individual QM jobs generated for each, and then data converted into the RESP format. Constraints are manually specified on multiple rows, which requires significant effort to input manually and is difficult to read and verify.

The online R.E.D. Tools (RESP and ESP charge Derive) [@dupradeau2007; @dupradeau2010] provide a much more accessible interface to the `resp` tool. It supports quantum chemistry jobs using both the Gaussian [@gaussian] and GAMESS [@gamess] QM engines, as well as both CHELPG [@breneman1990] and Connolly [@connolly1983] surfaces. Users can furthermore specify intramolecular and intermolecular charge constraints and charge equivalence constraints. The R.E.D. Tools use the canonical ``resp`` program for the actual charge fitting. However, conformer geometries must be provided by the user, and re-orientations of each conformer manually specified. Molecules must be provided in a specialized P2N format, and it is strongly recommended that a human user check each file before submission. Moreover, while standalone tools can be downloaded and run, full functionality is only available for jobs submitted to the server.

Finally, a Python RESP plugin for Psi4 also exists [@alenaizan2020]. Also called ``resp``, the plugin implements the RESP scheme but does not allow for intermolecular constraints. Intermolecular constraints are necessary for parametrising the atomic partial charges of multiple molecules (e.g. connected residues in a polymer) in tandem, so this poses a significant limitation for such goals. As with the canonical resp and the R.E.D. tools, all geometries must be specified by the user.

# Statement of Need

PsiRESP is a Python package that can be used to calculate ESP [@singh1984] and RESP charges [@bayly1993; @cornell1993; @cieplak1995], as well as the next-generation RESP2 scheme [@schauperl2020]. Both intra-molecular and inter-molecular charge constraints and charge equivalence constraints are supported. Users may generate their own conformers of a molecule, or conformers can be automatically generated. Multiple orientations can also be specified or automatically generated for each conformer, to ensure a generally applicable distribution of charges. Multiple atomic radii sets are supported, including the Bondi and Merz-Singh-Kollman sets of radii.

PsiRESP uses QCElemental [@qcelemental] and RDKit [@rdkit] to parse molecular input and output, meaning that it supports a wide array of formats, including XYZ and SMILES. A strict limitation is that elements and bond connectivity must be present in the file, or inferrable by proximity by Psi4. Conformers are embedded and generated using RDKit [@rdkit]. Quantum chemistry calculations are run in Psi4 [@psi4]. 

PsiRESP can be used interactively in a single job in connection with a QCFractal [@qcfractal] server. Alternatively, in acknowledgement of possible limits on time or other computing resources, users can use PsiRESP in two stages: first to generate input files for Psi4 that users can run manually or in parallel job submissions, and secondly to read the data computed from each file to finish the charge calculations.

The project contains a thorough Continuous Integration test suite ensuring that charges are comparable with those derived from other similar packages and previous versions. Code is written in a modular style, allowing for easy extension of capabilities, e.g. including charges computed from electric fields in the future, or using other QM engines. Core dependencies have been kept as minimal as possible to ease installation, although users are encouraged to make use of other packages (e.g. MDAnalysis [@michaud-agrawal2011; @gowers2016] or the OpenForceField toolkit [@openff-toolkit] for additional I/O and functionality). PsiRESP can be installed via `pip` and a `conda` package is forthcoming. Releases follow Semantic Versioning 2.0.

# Acknowledgements

This work was supported by a grant from the Australian Research Council (DP180103573). This project is based on the Computational Molecular Science Python Cookiecutter version 1.2. Pre-configured models and reorientation algorithm are written to directly match results from RESP ESP charge Derive (R.E.D.) [@dupradeau2007; @dupradeau2010]. ATBRESP tries to match results from Automated Topology Builder [@malde2011]. RESP2 tries to match results from RESP2 [@schauperl2020]. Some tests compare results to output from resp, the current RESP plugin for Psi4 [@alenaizan2020]. The research was undertaken with the assistance of resources and services from the National Computational Infrastructure (NCI), which is supported by the Australian Government.


# References